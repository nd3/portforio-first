# ポートフォリオサーバーを設定しよう

本稿では、当サイトのサーバー側の設定手順を記載しています。

## 0.前提条件

* AWSのアカウントを取得していること。
* AWSのセキュリティ対策として、IAMや多要素認証をしていること。
* 本稿では Mac mini(2023)(macOS Sonoma 14.3.1) を使用する。
* 構成は以下の通り
  * AWS EC2 にて、Ubuntu 20.04 LTS のインスタンスを作成する。
  * Web サーバーアプリケーションには Nginx を使用する。
  * 作成したページは2枚(ポートフォリオとなる `index.html` と、本稿 `/howto/infra_no1.html`)

## 1. EC2 インスタンスを起動する

### 1-1. EC2 インスタンスを作成する

AWS にルートユーザーでサインインし、AWS の画面左上の検索窓で「EC2」と入力して、EC2 ダッシュボードを開く。画面中央部の「インスタンスを起動」という橙色のボタンを押下する。

![EC2起動ボタン](<images/a_EC2起動ボタン.png>)

画面中央の「クイックスタート」で Ubuntu を選択する。Amazon マシンイメージ(AMI) は、今回の使用環境であり、かつ、無料利用枠の対象(※1)でもある、「Ubuntu Server 20.04 LTS (HVM), SSD Volume Type 」を選択する。アーキテクチャは、64ビット (Arm)を選択すると、無料利用枠の対象(※1)でなくなるため、64ビット (x86)のままにしておく。

※1 2024/2/20 時点

![OSイメージ選択](<images/b_OSイメージ選択.png>)
![インスタンスタイプ・キーペア](<images/c_インスタンスタイプ_キーペア.png>)
![ネットワーク設定](<images/d_ネットワーク設定.png>)

上図「ファイアウォール(セキュリティグループ)」では、「セキュリティグループを作成」「任意の場所」を選択し、「からの SSH トラフィックを許可」「インターネットからの HTTP トラフィックを許可」にチェックを入れる。(※2)

※2 上図では HTTPS にもチェックが入ってしまっているが、後で削除している。

### 1-2. キーペアの作成

起動するインスタンスに SSH でアクセスするため、キーペアを作成する。任意の名前をつけて、キーペアをダウンロードする。

![キーペア](<images/e_キーペア.png>)

### 1-3. インスタンスの起動

以上が完了したあと、「インスタンスの起動」ボタンを押下し、インスタンスを起動する。

### 1-4. ターミナルからリモート接続

ターミナルを開き、1-2. キーペアの作成 にて作成したキーペアを、 `~/.ssh` ディレクトリ配下に移動させる。ディレクトリがなければ作成する。
「インスタンスに接続」>「SSH クライアント」と画面遷移すると、以下のような接続手順が記されている。

1. SSH クライアントを開く。
2. プライベートキーファイルを見つける。このインスタンスの起動に使用されるキーは `xxx.pem`
3. 必要に応じて、以下のコマンドを実行して、キーが公開されていないことを確認する。`chmod 400 "xxx.pem"`
4.パブリック DNS を使用してインスタンスに接続
例: `ssh -i "xxx.pem" ubuntu@(割り当てられたパブリック IPv4 DNS)`

この手順に従って、SSH での接続を試みる。

![SSH 接続手順](<images/f_SSH接続手順.png>)

## 2. Nginx をインストールする

### 2-1. Nginx のインストール

Web サーバー用のソフトとして、Nginx を選択する。本稿の執筆時点で、Web サイトの用途は HTML を1ページ表示するにとどまり、ここからサイトをどのような方向性で展開していくか決めかねているため、一旦、直近で学習した Nginx の復習がてら、設定をしていく。また、Nginx の方がメモリの使用量が少ないため、EC2 の無料枠を使用している状況下にも向いていると考えた。

以下のコマンドを実行して、Nginx をインストールする。

```shell
sudo apt update
sudo apt install nginx
```

![nginx インストール](<images/g_nginxインストール.png>)

一度、インストールに成功しているか、ブラウザで確認する。`http://(コピーしたIP アドレス)` にアクセスして、以下のような画面が表示されていればよい。

![nginx トップページ](<images/h_nginxトップページ.png>)

### 2-2. 作成した HTML の転送

　作成したHTML をEC2 インスタンスに配置し、公開する。以下のコマンド( SSH 接続に使ったものの `ssh` を `sftp` に置き換えたもの)でログインできる。

```shell
sftp -i "~/.ssh/xxx.pem" ubuntu@(割り当てられたパブリック IPv4 DNS)
```

SFTP では、`cd` や`ls` などのコマンドが使えるため、それを利用して、ドキュメントルートの`/var/www/html` にリモートのカレントディレクトリを移動させ... たいところだが、EC2 のユーザーまわりの設定がそのままだと、ドキュメントルートへのパーミッションがないのか、`Permission Denied.` が発生してしまう。そのため、一旦、`/home/ubuntu` 下に転送用の一時的なディレクトリ`temp` を作成し、そこから再度 SSH でログインして、`mv` コマンドで移動させるようにする。

　また、`lcd` や`lls` など、通常のコマンドに`l` をつけることで、ローカルの操作が可能となる。これを使い、ローカルのカレントディレクトリを、作成した HTML が置かれている場所に移動させる。

カレントディレクトリの移動が完了したら、ディレクトリの構成が一致するように、mkdir でディレクトリを作成する。Ubuntu では、SFTP の`put` コマンドで、ディレクトリとその配下のファイルを転送できないバグ？があるためである。

　ディレクトリ構成が一致したら、`put` コマンドで各ディレクトリごとに必要なファイルを転送する。

```sftp
> put (ローカルのファイル名) (リモートのディレクトリ名)
```

すべてのファイルの転送に成功したら、SFTP からログアウトし、再度 SSH でログインする。その後、以下のコマンドで、まとめて移動する。

```shell
sudo mv ~/temp/* /var/www/html/
```

再度ブラウザでアクセスすると、以下のように、作成したポートフォリオが表示できるようになった。

![ポートフォリオ表示テスト](<images/i_ポートフォリオ表示テスト.png>)

## 3. まとめと今後の展望

今回は、EC2 インスタンスを起動し、Nginx をインストール、作成した HTML ファイルの配置を行った。ドキュメントの作成や、キャプチャの撮影等をしながらの作業のため、正確な所要時間は不明だが、他の作業も入れると8時間ほどだったと思われる。この一連の流れで、SFTP でファイルを転送するところに課題があった。今後は、SFTP 専用のユーザーを作成して、ドキュメントルートに直接転送できるように考えていきたい。また、作成した Web サイトは HTTP 接続のため、HTTPS 化もしていきたい。そうすると、AWS 環境では、Let’s encrypt を AWS のドメインでは発行できないという、証明書の問題が発生する。そのため、独自ドメインの取得なども視野に入る。

## 4. 参考文献

Nginx とは？ Apache との違いについて分かりやすく解説！ (<https://academy.gmocloud.com/qa/20160616/2761> 閲覧日:2024-02-21, 更新日:2016-06-16)
